{% extends "bootstrap/base.html" %} {% load static %} {% load martortags %}
{%block title %} Blog post {% endblock %} {% block css%}
<link
  href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
  rel="stylesheet"
/>
<link
  href="{% static 'plugins/css/ace.min.css' %}"
  type="text/css"
  media="all"
  rel="stylesheet"
/>
<link
  href="{% static 'martor/css/martor.bootstrap.css' %}"
  type="text/css"
  media="all"
  rel="stylesheet"
/>
<link
  href="{% static 'plugins/css/bootstrap.min.css' %}"
  type="text/css"
  media="all"
  rel="stylesheet"
/>
<link
  href="{% static 'main.css' %}"
  type="text/css"
  media="all"
  rel="stylesheet"
/>

{% endblock %} {% block content %}
<div class="martor-content">
  <div class="flex flex-wrap mt-4">
    {% for tag in tags %}
    <a
      href="{% url 'tag_detail' tag.name %}"
      class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2 hover:bg-gray-100 transition duration-100 ease-in-out hover:border-1"
      >{{ tag.name }}</a
    >
    {% endfor %}
  </div>
  <h1 class="truncate text-6xl">
    <span class="truncate text-black font-bold text-6xl"> {{ post.tag }} </span>
  </h1>
  <h1 class="truncate text-6xl">
    <span class="truncate text-black font-bold text-6xl">
      {{ post.title }}
    </span>
  </h1>
  <h3 class="text-black">
    Author: {{ author.username }}
    <h6 class="text-gray-600">{{post.created_on}}</h6>
  </h3>
  <hr />
  <div class="martor-preview">{{ post.description|safe_markdown }}</div>
  <button class="btn btn-primary btn-lg" onclick="window.history.back()">
    Back
  </button>
  <h2>Comments</h2>
  <div class="comment-section">
      {% for comment in comments %}
          {% include "comments.html" with comment=comment level=0 %}
      {% endfor %}
  </div>

  <h2>Leave a comment</h2>
  <form method="post" class="ajax-comment-form">
      {% csrf_token %}
      {{ comment_form.as_p }}
      <button type="submit">Add Comment</button>
  </form>


</div>
{% endblock %} {% block js %}
<script
  type="text/javascript"
  src="{% static 'plugins/js/highlight.min.js' %}"
></script>
<script>
  $(".martor-preview pre").each(function (i, block) {
    hljs.highlightBlock(block);
  });
</script>
<script>
  $(document).ready(function() {
      $('.ajax-comment-form').on('submit', function(event) {
          event.preventDefault();
          var $form = $(this);
          $.ajax({
              type: $form.attr('method'),
              url: $form.attr('action'),
              data: $form.serialize(),
              success: function(response) {
                  if (response.parent_id) {
                    var newCommentHtml = `
                    <div style="margin-left: 20px; margin-top: 10px; border: 1px solid #ddd; padding: 10px;">
                        <p>${response.content}</p>
                        <p><small>${response.created_on}</small></p>
                    </div>
                `;
                      var $parentReplies = $('#replies-' + response.parent_id);
                      if ($parentReplies.length) {
                          $parentReplies.append(newCommentHtml);
                          $parentReplies.show();
                      } else {
                        let $parrentComment = $(`#comment-${response.parent_id}`);
                        $parrentComment.append(
                          `
                          <div id=replies-${response.id} style=" margin-left: 40px; margin-top: 10px; border: 1px solid #ddd; padding: 10px;">
                            <p>${response.content}</p>
                            <p><small>${response.created_on}</small></p>
                        </div>
    
                          <button id="show-replies-${response.id}" onclick="$('#replies-${response.id}').toggle(); this.innerText = this.innerText === 'Show more' ? 'Show less' : 'Show more';">Show less</button>
                          `
                        )
                      }
                  } else {
                    var newCommentHtml = `
                    <div style="margin-left: 0px; margin-top: 10px; border: 1px solid #ddd; padding: 10px;">
                        <p>${response.content}</p>
                        <p><small>${response.created_on}</small></p>
                    </div>
                `;
                      $('.comment-section').append(newCommentHtml);
                  }
                  $form[0].reset();
                  // $form.parent().hide();
              },
              error: function(xhr, errmsg, err) {
                  console.log(xhr.status + ": " + xhr.responseText);
              }
          });
      });
  });
  </script>

{% endblock %}
